name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  BUILD_TYPE: Release
  DICOM_VIEWER_BENCHMARK_MULTIPLIER: "3.0"

jobs:
  build-and-test:
    name: Build & Test
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      # ---------------------------------------------------------------
      # 1. Checkout
      # ---------------------------------------------------------------
      - name: Checkout dicom_viewer
        uses: actions/checkout@v4

      # ---------------------------------------------------------------
      # 2. Install all dependencies via Homebrew (pre-built bottles)
      # ---------------------------------------------------------------
      - name: Install dependencies
        run: |
          brew install itk fftw spdlog fmt nlohmann-json googletest expat

      # ---------------------------------------------------------------
      # 3. Clone kcenon ecosystem (pacs_system + transitive deps)
      # ---------------------------------------------------------------
      - name: Clone ecosystem dependencies
        run: |
          cd "$GITHUB_WORKSPACE/.."
          git clone --depth 1 https://github.com/kcenon/common_system.git
          git clone --depth 1 https://github.com/kcenon/container_system.git
          git clone --depth 1 https://github.com/kcenon/thread_system.git
          git clone --depth 1 https://github.com/kcenon/logger_system.git
          git clone --depth 1 https://github.com/kcenon/network_system.git
          git clone --depth 1 https://github.com/kcenon/pacs_system.git

      # ---------------------------------------------------------------
      # 4. Build pacs_system (produces static libs in build/lib/)
      # ---------------------------------------------------------------
      - name: Cache pacs_system build
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/../pacs_system/build
          key: pacs-build-${{ runner.os }}-${{ runner.arch }}-v1
          restore-keys: |
            pacs-build-${{ runner.os }}-${{ runner.arch }}-

      - name: Build pacs_system
        run: |
          cmake -S "$GITHUB_WORKSPACE/../pacs_system" \
                -B "$GITHUB_WORKSPACE/../pacs_system/build" \
                -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
                -DPACS_BUILD_TESTS=OFF \
                -DPACS_BUILD_EXAMPLES=OFF \
                -DPACS_BUILD_BENCHMARKS=OFF \
                -DPACS_BUILD_SAMPLES=OFF \
                -DPACS_WARNINGS_AS_ERRORS=OFF
          cmake --build "$GITHUB_WORKSPACE/../pacs_system/build" \
                --config $BUILD_TYPE \
                -j $(sysctl -n hw.ncpu)

      # ---------------------------------------------------------------
      # 5. Configure & build dicom_viewer
      # ---------------------------------------------------------------
      - name: Configure
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
            -DCMAKE_PREFIX_PATH="/opt/homebrew;/opt/homebrew/opt/expat" \
            -DCMAKE_FIND_FRAMEWORK=LAST \
            -DBUILD_TESTS=ON

      - name: Build
        id: build
        run: |
          cmake --build build \
            --config $BUILD_TYPE \
            -j $(sysctl -n hw.ncpu)

      # ---------------------------------------------------------------
      # 6. Run tests (categorized for clear failure reporting)
      # ---------------------------------------------------------------
      - name: Run unit tests
        id: unit-tests
        if: always() && steps.build.outcome == 'success'
        working-directory: build
        run: |
          ctest --output-on-failure --timeout 120 \
            -E "(integration|benchmark|concurrency)" \
            --output-junit unit-test-results.xml \
            -j $(sysctl -n hw.ncpu)

      - name: Run concurrency tests
        id: concurrency-tests
        if: always() && steps.build.outcome == 'success'
        working-directory: build
        run: |
          ctest --output-on-failure --timeout 120 \
            -R "concurrency" \
            --output-junit concurrency-test-results.xml \
            -j 1

      - name: Run benchmark tests
        id: benchmark-tests
        if: always() && steps.build.outcome == 'success'
        working-directory: build
        run: |
          ctest --output-on-failure --timeout 120 \
            -R "benchmark" \
            --output-junit benchmark-test-results.xml \
            -j 1

      - name: Run integration tests
        id: integration-tests
        if: always() && steps.build.outcome == 'success'
        working-directory: build
        run: |
          ctest --output-on-failure --timeout 300 \
            -R "integration" \
            --output-junit integration-test-results.xml \
            -j 1

      # ---------------------------------------------------------------
      # 7. Test result reporting
      # ---------------------------------------------------------------
      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action/macos@v2
        if: always() && steps.build.outcome == 'success'
        with:
          files: build/*-test-results.xml
          check_name: Test Results
          comment_mode: always

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.sha }}
          path: build/*-test-results.xml
          retention-days: 30

      # ---------------------------------------------------------------
      # 8. Test summary
      # ---------------------------------------------------------------
      - name: Generate test summary
        if: always() && steps.build.outcome == 'success'
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ steps.unit-tests.outcome == 'success' && '✅ Pass' || '❌ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Concurrency Tests | ${{ steps.concurrency-tests.outcome == 'success' && '✅ Pass' || '❌ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Benchmark Tests | ${{ steps.benchmark-tests.outcome == 'success' && '✅ Pass' || '❌ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ steps.integration-tests.outcome == 'success' && '✅ Pass' || '❌ Fail' }} |" >> $GITHUB_STEP_SUMMARY
