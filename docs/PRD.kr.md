# DICOM Viewer - Product Requirements Document (PRD)

> **Version**: 0.2.0
> **Created**: 2025-12-31
> **Last Updated**: 2025-12-31
> **Status**: Draft (Pre-release)
> **Author**: Development Team

---

## 1. Executive Summary

### 1.1 Product Vision

**DICOM Viewer**는 의료 영상 전문가를 위한 고성능 의료 영상 뷰어로, CT와 MRI 영상의 3D 볼륨 렌더링 및 MPR(Multi-Planar Reconstruction) 뷰를 우선적으로 지원하며, DR/CR 영상의 기본 2D 뷰잉 기능을 제공합니다.

### 1.2 Goals

| 목표 | 설명 | 우선순위 |
|------|------|----------|
| **CT/MRI 3D 시각화** | 볼륨 렌더링, 표면 렌더링, MPR 뷰 제공 | P0 (Critical) |
| **영역 세그먼테이션** | 자동/반자동/수동 분할 도구, 다중 레이블 지원, 형태학적 후처리 | P1 (High) |
| **영역 측정 및 분석** | ROI 기반 면적/볼륨 측정, HU 통계, 정량 분석, 리포트 생성 | P1 (High) |
| **DR/CR 2D 뷰잉** | 기본 2D 영상 뷰잉 및 Window/Level 조정 | P2 (Medium) |
| **PACS 연동** | C-FIND, C-MOVE, C-STORE를 통한 PACS 통합 | P1 (High) |

### 1.3 Success Criteria

- CT/MRI 시리즈 로딩 시간: 512x512x300 볼륨 기준 **3초 이내**
- 볼륨 렌더링 프레임 레이트: **30 FPS 이상**
- 메모리 사용량: 1GB 볼륨 데이터 기준 **2GB 이내**
- 지원 압축 포맷: JPEG, JPEG 2000, JPEG-LS, RLE

---

## 2. Target Users

### 2.1 Primary Personas

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          User Personas                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────┐   ┌─────────────────────┐                    │
│   │   영상의학과 전문의   │   │    연구자/개발자     │                    │
│   │      (Primary)       │   │     (Secondary)      │                    │
│   │                      │   │                      │                    │
│   │  • CT/MRI 판독       │   │  • 알고리즘 검증     │                    │
│   │  • 3D 재구성 분석    │   │  • 영상 처리 연구    │                    │
│   │  • 측정/정량 분석    │   │  • 분할 알고리즘     │                    │
│   │                      │   │                      │                    │
│   │  Needs:              │   │  Needs:              │                    │
│   │  - 빠른 로딩         │   │  - API 접근성        │                    │
│   │  - 직관적 UI         │   │  - 확장 가능성       │                    │
│   │  - 정확한 측정       │   │  - 데이터 내보내기   │                    │
│   └─────────────────────┘   └─────────────────────┘                    │
│                                                                         │
│   ┌─────────────────────┐                                              │
│   │    방사선사/기사     │                                              │
│   │     (Tertiary)       │                                              │
│   │                      │                                              │
│   │  • DR/CR 영상 확인   │                                              │
│   │  • 영상 품질 점검    │                                              │
│   │  • PACS 전송         │                                              │
│   │                      │                                              │
│   │  Needs:              │                                              │
│   │  - 간편한 조작       │                                              │
│   │  - 빠른 확인         │                                              │
│   │  - PACS 연동         │                                              │
│   └─────────────────────┘                                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Use Cases

| ID | 사용자 | 시나리오 | 우선순위 |
|----|--------|----------|----------|
| UC-01 | 영상의학과 전문의 | CT 흉부 영상 볼륨 렌더링으로 폐 구조 확인 | P0 |
| UC-02 | 영상의학과 전문의 | MRI 뇌 영상 MPR 뷰로 단면별 분석 | P0 |
| UC-03 | 영상의학과 전문의 | CT 영상에서 종양 크기 측정 (거리, 면적, 볼륨) | P1 |
| UC-04 | 연구자 | 특정 조직 분할 후 3D 표면 추출 | P1 |
| UC-05 | 방사선사 | DR 흉부 영상 Window/Level 조정 확인 | P2 |
| UC-06 | 방사선사 | PACS에서 영상 검색 및 다운로드 | P1 |
| UC-07 | 영상의학과 전문의 | CT 간 영상에서 간 영역 세그먼테이션 후 볼륨 측정 | P1 |
| UC-08 | 영상의학과 전문의 | 종양 ROI 설정 후 HU 통계값 분석 (Mean, StdDev) | P1 |
| UC-09 | 연구자 | 다중 장기 분할 (간, 비장, 신장) 후 비교 분석 | P1 |
| UC-10 | 연구자 | 분할 결과 NRRD 저장 및 분석 리포트 생성 | P2 |

---

## 3. Functional Requirements

### 3.1 Priority Definitions

| 우선순위 | 설명 | 릴리스 목표 |
|----------|------|-------------|
| **P0 (Critical)** | MVP 필수 기능 | v0.3.0 |
| **P1 (High)** | 핵심 가치 제공 | v0.4.0 |
| **P2 (Medium)** | 사용성 개선 | v0.5.0 |
| **P3 (Low)** | 향후 확장 | v1.0.0+ |

### 3.2 CT/MRI Viewing (P0 - Critical)

#### FR-001: DICOM 시리즈 로딩

```
┌─────────────────────────────────────────────────────────────────┐
│                    DICOM Loading Pipeline                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐│
│   │ pacs_system │ →  │    ITK      │ →  │        VTK          ││
│   │             │    │             │    │                     ││
│   │ • DICOM I/O │    │ • 3D Volume │    │ • vtkImageData      ││
│   │ • Metadata  │    │   Assembly  │    │ • Direction Matrix  ││
│   │ • Decompress│    │ • HU Convert│    │                     ││
│   └─────────────┘    └─────────────┘    └─────────────────────┘│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

| 요구사항 | 설명 |
|----------|------|
| FR-001.1 | 로컬 디렉토리에서 DICOM 시리즈 로드 |
| FR-001.2 | Slice Location / Instance Number 기반 자동 정렬 |
| FR-001.3 | 압축 포맷 자동 감지 및 디코딩 (JPEG, JPEG2000, RLE) |
| FR-001.4 | 메타데이터 추출 (Patient, Study, Series, Image 정보) |
| FR-001.5 | Rescale Slope/Intercept 적용하여 HU 값 변환 |

#### FR-002: 볼륨 렌더링 (Volume Rendering)

| 요구사항 | 설명 |
|----------|------|
| FR-002.1 | GPU 가속 Ray Casting 볼륨 렌더링 |
| FR-002.2 | Color Transfer Function 편집 기능 |
| FR-002.3 | Opacity Transfer Function 편집 기능 |
| FR-002.4 | 사전 정의된 프리셋 제공 (CT Bone, CT Soft Tissue, CT Lung, CT Angio, MRI) |
| FR-002.5 | 실시간 조명 및 쉐이딩 조절 |
| FR-002.6 | 볼륨 클리핑 (Box Widget) |

**CT Transfer Function 프리셋:**

| 프리셋 | Window Width | Window Center | 용도 |
|--------|--------------|---------------|------|
| CT Bone | 2000 | 400 | 뼈 구조 |
| CT Soft Tissue | 400 | 40 | 연조직 |
| CT Lung | 1500 | -600 | 폐 |
| CT Angio | 400 | 200 | 혈관 |
| CT Abdomen | 400 | 50 | 복부 |

#### FR-003: MPR (Multi-Planar Reconstruction)

```
┌─────────────────────────────────────────────────────────────────┐
│                         MPR Layout                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌───────────────────┐   ┌───────────────────┐                │
│   │      Axial        │   │     Coronal       │                │
│   │       (XY)        │   │       (XZ)        │                │
│   │                   │   │                   │                │
│   │    ┌─────────┐    │   │    ┌─────────┐    │                │
│   │    │  Top    │    │   │    │  Front  │    │                │
│   │    │  View   │    │   │    │  View   │    │                │
│   │    └─────────┘    │   │    └─────────┘    │                │
│   └───────────────────┘   └───────────────────┘                │
│                                                                 │
│   ┌───────────────────┐   ┌───────────────────┐                │
│   │     Sagittal      │   │    3D Volume      │                │
│   │       (YZ)        │   │   or Oblique      │                │
│   │                   │   │                   │                │
│   │    ┌─────────┐    │   │    ┌─────────┐    │                │
│   │    │  Side   │    │   │    │  3D/Obl │    │                │
│   │    │  View   │    │   │    │  View   │    │                │
│   │    └─────────┘    │   │    └─────────┘    │                │
│   └───────────────────┘   └───────────────────┘                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

| 요구사항 | 설명 |
|----------|------|
| FR-003.1 | Axial, Coronal, Sagittal 동시 표시 (2x2 레이아웃) |
| FR-003.2 | 슬라이스 스크롤 (마우스 휠, 슬라이더) |
| FR-003.3 | 크로스헤어 동기화 (한 뷰에서 클릭 시 다른 뷰 업데이트) |
| FR-003.4 | Window/Level 조절 (마우스 드래그) |
| FR-003.5 | Oblique 리슬라이스 (임의 각도 단면) |
| FR-003.6 | Thick Slab (MIP, MinIP, AverageIP) |

#### FR-004: 표면 렌더링 (Surface Rendering)

| 요구사항 | 설명 |
|----------|------|
| FR-004.1 | Marching Cubes 등표면 추출 |
| FR-004.2 | 임계값 기반 조직별 표면 생성 |
| FR-004.3 | 표면 스무딩 및 데시메이션 |
| FR-004.4 | 다중 표면 동시 렌더링 (색상별 구분) |
| FR-004.5 | STL/PLY 내보내기 |

### 3.3 Image Processing (P1 - High)

#### FR-005: 전처리 (Preprocessing)

| 요구사항 | 설명 |
|----------|------|
| FR-005.1 | Gaussian Smoothing (노이즈 제거) |
| FR-005.2 | Anisotropic Diffusion (엣지 보존 스무딩) |
| FR-005.3 | Histogram Equalization (대비 향상) |
| FR-005.4 | N4 Bias Field Correction (MRI 불균일 보정) |
| FR-005.5 | Isotropic Resampling (등방성 복셀 변환) |

#### FR-006: 분할 (Segmentation)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Segmentation Workflow                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌───────────────────────────────────────────────────────────────────┐│
│   │                    1. ROI Selection                                ││
│   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐  ││
│   │   │  Manual  │  │  Semi-   │  │   Auto   │  │   AI-Assisted    │  ││
│   │   │   ROI    │  │   Auto   │  │ Threshold│  │   (향후 확장)    │  ││
│   │   └──────────┘  └──────────┘  └──────────┘  └──────────────────┘  ││
│   └───────────────────────────────────────────────────────────────────┘│
│                              │                                          │
│                              ↓                                          │
│   ┌───────────────────────────────────────────────────────────────────┐│
│   │                    2. Segmentation Tools                           ││
│   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐  ││
│   │   │  Brush   │  │  Eraser  │  │  Fill    │  │   Smart Select   │  ││
│   │   │   Tool   │  │   Tool   │  │  Tool    │  │   (Grow from     │  ││
│   │   │          │  │          │  │          │  │    click point)  │  ││
│   │   └──────────┘  └──────────┘  └──────────┘  └──────────────────┘  ││
│   └───────────────────────────────────────────────────────────────────┘│
│                              │                                          │
│                              ↓                                          │
│   ┌───────────────────────────────────────────────────────────────────┐│
│   │                    3. Post-Processing                              ││
│   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐  ││
│   │   │  Smooth  │  │   Fill   │  │  Dilate/ │  │   Island         │  ││
│   │   │  Edges   │  │  Holes   │  │  Erode   │  │   Removal        │  ││
│   │   └──────────┘  └──────────┘  └──────────┘  └──────────────────┘  ││
│   └───────────────────────────────────────────────────────────────────┘│
│                              │                                          │
│                              ↓                                          │
│   ┌───────────────────────────────────────────────────────────────────┐│
│   │                    4. Analysis & Export                            ││
│   │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐  ││
│   │   │  Volume  │  │ Surface  │  │  Stats   │  │   Export         │  ││
│   │   │  Calc    │  │ Extract  │  │  Report  │  │   (STL/NRRD)     │  ││
│   │   └──────────┘  └──────────┘  └──────────┘  └──────────────────┘  ││
│   └───────────────────────────────────────────────────────────────────┘│
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**FR-006.A: 자동/반자동 분할 알고리즘**

| 요구사항 | 설명 | 우선순위 |
|----------|------|----------|
| FR-006.1 | 수동 임계값 분할 (Min/Max HU 범위 지정) | P1 |
| FR-006.2 | Otsu 자동 임계값 (단일/다중 클래스) | P1 |
| FR-006.3 | Region Growing (시드 포인트 기반, 클릭으로 시드 설정) | P1 |
| FR-006.4 | Confidence Connected (자동 임계값 Region Growing) | P1 |
| FR-006.5 | Level Set 분할 (Geodesic Active Contour) | P2 |
| FR-006.6 | Watershed 분할 (경계 기반) | P2 |

**FR-006.B: 수동 분할 도구**

| 요구사항 | 설명 | 우선순위 |
|----------|------|----------|
| FR-006.7 | 브러시 도구 (크기 조절 가능, 원형/사각형) | P1 |
| FR-006.8 | 지우개 도구 (분할 영역 삭제) | P1 |
| FR-006.9 | 채우기 도구 (폐쇄 영역 채우기) | P1 |
| FR-006.10 | 자유 곡선 도구 (Freehand drawing) | P1 |
| FR-006.11 | 다각형 도구 (Polygon ROI) | P1 |
| FR-006.12 | 스마트 가위 도구 (경계 추적) | P2 |

**FR-006.C: 분할 편집 및 관리**

| 요구사항 | 설명 | 우선순위 |
|----------|------|----------|
| FR-006.13 | 다중 레이블 지원 (여러 장기/조직 동시 분할) | P1 |
| FR-006.14 | 레이블별 색상 지정 | P1 |
| FR-006.15 | 실행 취소/다시 실행 (Undo/Redo) | P1 |
| FR-006.16 | 슬라이스별 분할 → 3D 보간 | P2 |
| FR-006.17 | 분할 결과 저장 (NRRD, NIfTI 포맷) | P1 |
| FR-006.18 | 분할 결과 불러오기 | P1 |

**FR-006.D: 형태학적 후처리**

| 요구사항 | 설명 | 우선순위 |
|----------|------|----------|
| FR-006.19 | 열기 연산 (Opening) - 작은 돌기 제거 | P1 |
| FR-006.20 | 닫기 연산 (Closing) - 작은 구멍 채우기 | P1 |
| FR-006.21 | 팽창 (Dilation) | P1 |
| FR-006.22 | 침식 (Erosion) | P1 |
| FR-006.23 | 구멍 채우기 (Fill Holes) | P1 |
| FR-006.24 | 작은 영역 제거 (Island Removal, 크기 임계값 지정) | P1 |
| FR-006.25 | 최대 연결 요소만 유지 (Keep Largest Connected Component) | P1 |

**분할 대상 프리셋 (CT):**

| 프리셋 | HU 범위 | 용도 | 알고리즘 |
|--------|---------|------|----------|
| Bone | 200 ~ 3000 | 뼈 추출 | Threshold + Morphology |
| Soft Tissue | -100 ~ 200 | 연조직 | Region Growing |
| Lung | -950 ~ -400 | 폐 실질 | Threshold + Hole Fill |
| Liver | 40 ~ 80 | 간 | Region Growing |
| Vessel (Contrast) | 150 ~ 500 | 혈관 (조영제) | Threshold |
| Fat | -150 ~ -50 | 지방 | Threshold |

#### FR-007: 측정 (Measurement)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Measurement Tools                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                    Linear Measurements                           │  │
│   │                                                                   │  │
│   │   ┌────────────┐   ┌────────────┐   ┌────────────────────────┐  │  │
│   │   │  Distance  │   │   Angle    │   │   Cobb Angle           │  │  │
│   │   │   (2pts)   │   │   (3pts)   │   │   (Spine analysis)     │  │  │
│   │   │    ↔       │   │     ∠      │   │      ⟨  ⟩             │  │  │
│   │   └────────────┘   └────────────┘   └────────────────────────┘  │  │
│   │                                                                   │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                      Area Measurements                           │  │
│   │                                                                   │  │
│   │   ┌────────────┐   ┌────────────┐   ┌────────────────────────┐  │  │
│   │   │  Ellipse   │   │  Polygon   │   │   Freehand ROI         │  │  │
│   │   │    ROI     │   │    ROI     │   │                        │  │  │
│   │   │     ⬭     │   │     ⬡      │   │      ～～～            │  │  │
│   │   └────────────┘   └────────────┘   └────────────────────────┘  │  │
│   │                                                                   │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                    Volume Measurements                           │  │
│   │                                                                   │  │
│   │   ┌────────────────────────────────────────────────────────────┐│  │
│   │   │   Segmented Volume   │   3D ROI Box   │   Spherical ROI   ││  │
│   │   │        ▣            │       ⬜        │         ⬤         ││  │
│   │   └────────────────────────────────────────────────────────────┘│  │
│   │                                                                   │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**FR-007.A: 선형 측정 (Linear Measurements)**

| 요구사항 | 설명 | 우선순위 |
|----------|------|----------|
| FR-007.1 | 거리 측정 (2점 사이, mm 단위) | P1 |
| FR-007.2 | 다중 거리 측정 (연속 측정) | P1 |
| FR-007.3 | 각도 측정 (3점, 도 단위) | P1 |
| FR-007.4 | Cobb 각도 측정 (척추 분석용 4점) | P2 |
| FR-007.5 | 측정 주석 표시 (화면에 값 오버레이) | P1 |

**FR-007.B: 면적 및 ROI 측정 (Area Measurements)**

| 요구사항 | 설명 | 우선순위 |
|----------|------|----------|
| FR-007.6 | 원형/타원형 ROI 면적 측정 (mm²) | P1 |
| FR-007.7 | 사각형 ROI 면적 측정 | P1 |
| FR-007.8 | 다각형 ROI 면적 측정 | P1 |
| FR-007.9 | 자유 곡선 ROI 면적 측정 | P1 |
| FR-007.10 | ROI 내 둘레 측정 (mm) | P1 |

**FR-007.C: 볼륨 측정 (Volume Measurements)**

| 요구사항 | 설명 | 우선순위 |
|----------|------|----------|
| FR-007.11 | 분할 영역 볼륨 계산 (mm³, cm³, mL) | P1 |
| FR-007.12 | 3D Bounding Box 볼륨 | P2 |
| FR-007.13 | 구형 ROI 볼륨 | P2 |
| FR-007.14 | 다중 레이블별 볼륨 비교 | P1 |

**FR-007.D: 영역 통계 분석 (ROI Statistics)**

| 요구사항 | 설명 | 우선순위 |
|----------|------|----------|
| FR-007.15 | 평균값 (Mean HU/Signal Intensity) | P1 |
| FR-007.16 | 표준편차 (Standard Deviation) | P1 |
| FR-007.17 | 최소/최대값 (Min/Max) | P1 |
| FR-007.18 | 중앙값 (Median) | P1 |
| FR-007.19 | 히스토그램 표시 | P1 |
| FR-007.20 | 픽셀/복셀 개수 | P1 |

**FR-007.E: 고급 정량 분석**

| 요구사항 | 설명 | 우선순위 |
|----------|------|----------|
| FR-007.21 | 분할 영역 표면적 계산 (mm²) | P2 |
| FR-007.22 | 구형도 (Sphericity) 계산 | P2 |
| FR-007.23 | 신장비 (Elongation) 계산 | P2 |
| FR-007.24 | 무게 중심 좌표 | P2 |
| FR-007.25 | 주축 방향 (Principal Axes) | P3 |

#### FR-012: ROI 관리 (ROI Management) - P1

| 요구사항 | 설명 |
|----------|------|
| FR-012.1 | ROI 목록 패널 (생성된 모든 ROI 표시) |
| FR-012.2 | ROI 이름 지정 및 편집 |
| FR-012.3 | ROI 표시/숨기기 토글 |
| FR-012.4 | ROI 색상 변경 |
| FR-012.5 | ROI 복사/붙여넣기 (다른 슬라이스로) |
| FR-012.6 | ROI 삭제 |
| FR-012.7 | ROI 저장 (DICOM SR, JSON, CSV) |
| FR-012.8 | ROI 불러오기 |

#### FR-013: 분석 리포트 생성 (Analysis Report) - P2

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Analysis Report Template                            │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Patient: [Name]              Study Date: [Date]                       │
│   Patient ID: [ID]             Modality: [CT/MRI]                       │
│   ─────────────────────────────────────────────────────────────────    │
│                                                                         │
│   Segmentation Results:                                                 │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  Label        │  Volume (cm³)  │  Mean HU  │  Surface (cm²)    │  │
│   │──────────────────────────────────────────────────────────────── │  │
│   │  Liver        │     1523.5     │    55.2   │     845.3         │  │
│   │  Tumor        │      12.8      │    42.1   │      28.6         │  │
│   │  Bone         │     2341.2     │   456.8   │    1204.5         │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│   ROI Measurements:                                                     │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │  ROI Name     │  Type    │  Value    │  Location              │  │
│   │──────────────────────────────────────────────────────────────── │  │
│   │  Distance 1   │  Length  │  45.2 mm  │  Slice 120             │  │
│   │  Lesion ROI   │  Area    │  125 mm²  │  Slice 145             │  │
│   │  Angle 1      │  Angle   │  32.5°    │  Slice 120             │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│   [Screenshot thumbnails]                                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

| 요구사항 | 설명 |
|----------|------|
| FR-013.1 | 분할 결과 요약 (볼륨, 평균값, 표면적) |
| FR-013.2 | 측정 결과 목록 |
| FR-013.3 | 스크린샷 포함 |
| FR-013.4 | PDF 내보내기 |
| FR-013.5 | CSV/Excel 내보내기 (데이터만) |
| FR-013.6 | DICOM SR (Structured Report) 저장 |

### 3.4 DR/CR Viewing (P2 - Medium)

#### FR-008: 2D 영상 뷰잉

| 요구사항 | 설명 |
|----------|------|
| FR-008.1 | 단일 프레임 DICOM 로딩 |
| FR-008.2 | Window/Level 조절 |
| FR-008.3 | 확대/축소 및 팬 |
| FR-008.4 | 회전 (90도 단위, 자유 회전) |
| FR-008.5 | 좌우 반전, 상하 반전 |
| FR-008.6 | 그리드 뷰 (다중 영상 비교) |

#### FR-009: 2D 영상 프리셋

| 프리셋 | Window Width | Window Center | 용도 |
|--------|--------------|---------------|------|
| Chest | 1500 | -600 | 흉부 X-ray |
| Abdomen | 400 | 40 | 복부 X-ray |
| Bone | 2000 | 300 | 골격 X-ray |
| Mammography | 2048 | 1024 | 유방 촬영 |

### 3.5 PACS Integration (P1 - High)

#### FR-010: 네트워크 서비스

| 요구사항 | 설명 |
|----------|------|
| FR-010.1 | C-ECHO (연결 테스트) |
| FR-010.2 | C-FIND (Patient/Study/Series/Image 레벨 검색) |
| FR-010.3 | C-MOVE (영상 가져오기) |
| FR-010.4 | C-STORE SCP (영상 수신) |
| FR-010.5 | PACS 서버 설정 관리 (AE Title, Host, Port) |

### 3.6 UI/UX (P1 - High)

#### FR-011: 사용자 인터페이스

```
┌─────────────────────────────────────────────────────────────────────────┐
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        Menu Bar                                  │   │
│  │  File  Edit  View  Tools  Image  Window  Help                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                        Tool Bar                                  │   │
│  │  [Open] [Save] [PACS] │ [Scroll] [Zoom] [Pan] [W/L] [Measure]   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│  ┌───────────┬─────────────────────────────────────┬───────────────┐   │
│  │           │                                     │               │   │
│  │  Patient  │                                     │   Tools /     │   │
│  │   List    │         Main Viewport               │   Properties  │   │
│  │           │                                     │               │   │
│  │  ───────  │    ┌─────────────────────────────┐  │   ─────────   │   │
│  │  Studies  │    │                             │  │   Window/     │   │
│  │  Series   │    │     2D / 3D View Area       │  │   Level       │   │
│  │  Images   │    │                             │  │   ─────────   │   │
│  │           │    │                             │  │   Transfer    │   │
│  │           │    │                             │  │   Function    │   │
│  │           │    └─────────────────────────────┘  │   ─────────   │   │
│  │           │                                     │   Measure     │   │
│  └───────────┴─────────────────────────────────────┴───────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      Status Bar                                  │   │
│  │  Patient: xxx  |  Series: xxx  |  Slice: 150/300  |  HU: 40     │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

| 요구사항 | 설명 |
|----------|------|
| FR-011.1 | Qt6 기반 네이티브 UI |
| FR-011.2 | 다크 테마 기본 지원 |
| FR-011.3 | 도킹 가능한 패널 구조 |
| FR-011.4 | 키보드 단축키 지원 |
| FR-011.5 | 다중 모니터 지원 |
| FR-011.6 | 레이아웃 저장/복원 |

---

## 4. Non-Functional Requirements

### 4.1 Performance

| ID | 요구사항 | 목표 |
|----|----------|------|
| NFR-001 | CT 시리즈 로딩 (512x512x300) | ≤ 3초 |
| NFR-002 | 볼륨 렌더링 FPS | ≥ 30 FPS |
| NFR-003 | MPR 슬라이스 전환 응답 | ≤ 100ms |
| NFR-004 | 메모리 사용량 (1GB 볼륨) | ≤ 2GB |
| NFR-005 | 시작 시간 (Cold Start) | ≤ 5초 |

### 4.2 Compatibility

| ID | 요구사항 | 상세 |
|----|----------|------|
| NFR-006 | 운영체제 | macOS 12+, Windows 10+, Ubuntu 20.04+ |
| NFR-007 | 그래픽 카드 | OpenGL 4.1+ 지원 GPU |
| NFR-008 | DICOM 표준 | DICOM PS3.x 준수 |
| NFR-009 | Transfer Syntax | JPEG, JPEG2000, JPEG-LS, RLE |

### 4.3 Usability

| ID | 요구사항 |
|----|----------|
| NFR-010 | 주요 기능 3클릭 이내 접근 가능 |
| NFR-011 | 신규 사용자 30분 내 기본 기능 습득 |
| NFR-012 | 오류 발생 시 명확한 에러 메시지 제공 |

### 4.4 Security

| ID | 요구사항 |
|----|----------|
| NFR-013 | DICOM 파일 내 환자 정보 익명화 기능 |
| NFR-014 | PACS 통신 시 TLS 암호화 지원 |
| NFR-015 | 로컬 설정 파일 암호화 |

---

## 5. Technology Stack

### 5.1 Core Technologies

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Technology Stack                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                      Presentation Layer                          │  │
│   │                                                                   │  │
│   │    Qt6 Widgets + QVTKOpenGLNativeWidget                          │  │
│   │                                                                   │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                     Visualization Layer                          │  │
│   │                                                                   │  │
│   │    VTK 9.x                                                        │  │
│   │    • vtkGPUVolumeRayCastMapper (볼륨 렌더링)                      │  │
│   │    • vtkImageReslice (MPR)                                        │  │
│   │    • vtkMarchingCubes (표면 추출)                                 │  │
│   │    • vtkImageViewer2 (2D 뷰)                                      │  │
│   │    • 상호작용 위젯                                                │  │
│   │                                                                   │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                      Processing Layer                            │  │
│   │                                                                   │  │
│   │    ITK 5.x                                                        │  │
│   │    • 영상 필터링 (Gaussian, Anisotropic Diffusion)               │  │
│   │    • 영상 분할 (Region Growing, Level Sets)                      │  │
│   │    • 영상 정합                                                    │  │
│   │    • N4 Bias Field Correction                                    │  │
│   │                                                                   │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                        Data Layer                                │  │
│   │                                                                   │  │
│   │    pacs_system (kcenon ecosystem)                                │  │
│   │    • DICOM 파일 파싱                                             │  │
│   │    • 메타데이터 추출                                             │  │
│   │    • Transfer Syntax 디코딩                                      │  │
│   │    • DICOM 네트워크 서비스 (C-FIND, C-MOVE, C-STORE)            │  │
│   │                                                                   │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                     Foundation Layer                             │  │
│   │                                                                   │  │
│   │    C++20 / CMake 3.20+                                           │  │
│   │    kcenon ecosystem (common_system, container_system,            │  │
│   │                       thread_system, network_system)             │  │
│   │                                                                   │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Version Requirements

| Component | Version | Purpose |
|-----------|---------|---------|
| **C++** | C++20 | 언어 표준 |
| **CMake** | 3.20+ | 빌드 시스템 |
| **Qt** | 6.5+ | GUI 프레임워크 |
| **VTK** | 9.3+ | 시각화 |
| **ITK** | 5.4+ | 영상 처리 |
| **pacs_system** | Latest | DICOM 처리 |

### 5.3 Build Dependencies

```cmake
# vcpkg.json
{
    "dependencies": [
        { "name": "itk", "features": ["vtk"] },
        { "name": "vtk", "features": ["qt"] },
        { "name": "qt6" },
        { "name": "pacs-system" }
    ]
}
```

---

## 6. Architecture Overview

### 6.1 High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        DICOM Viewer Architecture                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                          UI Layer                                │  │
│   │                                                                   │  │
│   │  MainWindow ─┬─ PatientBrowser (환자/시리즈 탐색)                │  │
│   │              ├─ ViewportManager (뷰포트 관리)                    │  │
│   │              ├─ ToolsPanel (도구 패널)                           │  │
│   │              └─ StatusBar (상태 표시)                            │  │
│   │                                                                   │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│                              ↓                                          │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                      Controller Layer                            │  │
│   │                                                                   │  │
│   │  ViewerController ─┬─ LoadingController (로딩 제어)              │  │
│   │                    ├─ RenderingController (렌더링 제어)          │  │
│   │                    ├─ ToolController (도구 제어)                 │  │
│   │                    └─ NetworkController (PACS 제어)              │  │
│   │                                                                   │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│                              ↓                                          │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                       Service Layer                              │  │
│   │                                                                   │  │
│   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────────────┐│  │
│   │  │ ImageService  │  │ RenderService │  │    NetworkService     ││  │
│   │  │               │  │               │  │                       ││  │
│   │  │ • Loading     │  │ • Volume      │  │ • C-FIND              ││  │
│   │  │ • Processing  │  │ • Surface     │  │ • C-MOVE              ││  │
│   │  │ • Segmentation│  │ • MPR         │  │ • C-STORE             ││  │
│   │  │ • Measurement │  │ • 2D View     │  │                       ││  │
│   │  └───────────────┘  └───────────────┘  └───────────────────────┘│  │
│   │                                                                   │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                              │                                          │
│                              ↓                                          │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                        Data Layer                                │  │
│   │                                                                   │  │
│   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────────────┐│  │
│   │  │ ImageData     │  │ DicomData     │  │     MetaData          ││  │
│   │  │               │  │               │  │                       ││  │
│   │  │ • ITK Image   │  │ • pacs_system │  │ • Patient Info        ││  │
│   │  │ • VTK Image   │  │   Dataset     │  │ • Study Info          ││  │
│   │  │               │  │               │  │ • Series Info         ││  │
│   │  └───────────────┘  └───────────────┘  └───────────────────────┘│  │
│   │                                                                   │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 Module Dependencies

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Module Dependencies                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   dicom_viewer_ui                                                       │
│        │                                                                │
│        ↓                                                                │
│   dicom_viewer_controller ←─────────────────────────────────┐          │
│        │                                                    │          │
│        ↓                                                    │          │
│   ┌────┴────┬────────────────┬────────────────┐             │          │
│   ↓         ↓                ↓                ↓             │          │
│   image_    render_          network_         measurement_  │          │
│   service   service          service          service       │          │
│   │         │                │                │             │          │
│   └────┬────┴────────────────┴────────────────┘             │          │
│        ↓                                                    │          │
│   dicom_viewer_core (공통 데이터 구조, 유틸리티)  ───────────┘          │
│        │                                                                │
│        ↓                                                                │
│   ┌────┴────┬────────────────┬────────────────┐                        │
│   ↓         ↓                ↓                ↓                        │
│   pacs_     ITK              VTK              Qt6                       │
│   system                                                                │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Milestone Plan

### 7.1 Release Schedule

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          Release Timeline                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Phase 1: Foundation        Phase 2: Core        Phase 3: Enhancement  │
│   ─────────────────          ──────────────       ──────────────────    │
│                                                                         │
│   v0.1 ──┬── v0.2 ──┬── v0.3 ──┬── v0.4 ──┬── v0.5 ──┬── v1.0         │
│   (Pre)  │  (Pre)   │  (MVP)   │  (Core)  │  (Enh)   │  (Release)      │
│   ┌──────┘   ┌──────┘   ┌──────┘   ┌──────┘   ┌──────┘                 │
│   │          │          │          │          │                         │
│   Week 1-2   Week 3-4   Week 5-8   Week 9-12  Week 13-16               │
│                                                                         │
│   • 프로젝트  • DICOM    • MPR 뷰   • PACS     • DR/CR                  │
│     설정       로딩     • 볼륨 렌더링  연동    • 고급 분할              │
│   • 기본 UI  • ITK/VTK  • 표면 렌더링• 측정    • 정량 분석             │
│              통합      • 프리셋    • 기본 분할 • 리포트                │
│                                                                         │
│   ※ v0.x.x: Pre-release (개발 중)  /  v1.0.0+: 정식 릴리스             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 7.2 Milestone Details

#### Milestone 1: Foundation (v0.1-v0.2) - Week 1-4

| 항목 | 설명 | 완료 기준 |
|------|------|-----------|
| M1.1 | 프로젝트 구조 설정 | CMake 빌드 성공 |
| M1.2 | Qt6 기본 UI | MainWindow, 기본 레이아웃 |
| M1.3 | pacs_system 연동 | 단일 DICOM 파일 로드 |
| M1.4 | ITK 연동 | pacs → ITK 3D 볼륨 변환 |
| M1.5 | VTK 연동 | ITK → VTK 변환, 기본 렌더링 |

#### Milestone 2: MVP - CT/MRI Viewer (v0.3.0) - Week 5-8

| 항목 | 설명 | 완료 기준 |
|------|------|-----------|
| M2.1 | DICOM 시리즈 로딩 | 512x512x300 볼륨 3초 이내 로드 |
| M2.2 | 볼륨 렌더링 | GPU Ray Casting, 30 FPS |
| M2.3 | MPR 뷰 | Axial/Coronal/Sagittal 동기화 |
| M2.4 | 표면 렌더링 | Marching Cubes, 스무딩 |
| M2.5 | 프리셋 | CT Bone, CT Soft Tissue, CT Lung |
| M2.6 | Window/Level | 마우스 드래그 조절 |

#### Milestone 3: Core Features (v0.4.0) - Week 9-12

| 항목 | 설명 | 완료 기준 |
|------|------|-----------|
| M3.1 | PACS C-FIND | 환자/연구/시리즈 검색 |
| M3.2 | PACS C-MOVE | 영상 가져오기 |
| M3.3 | 선형 측정 도구 | 거리(2점), 각도(3점), 측정값 오버레이 |
| M3.4 | ROI 측정 도구 | 원형/다각형/자유곡선 ROI, 면적 측정 |
| M3.5 | ROI 통계 분석 | Mean, StdDev, Min/Max, 히스토그램 |
| M3.6 | 기본 분할 도구 | 임계값 분할, Otsu 자동 임계값 |
| M3.7 | Region Growing | 시드 기반 영역 성장, Confidence Connected |
| M3.8 | 수동 분할 도구 | 브러시, 지우개, 채우기 도구 |
| M3.9 | 형태학적 후처리 | Opening, Closing, Fill Holes, Island Removal |
| M3.10 | 전처리 | Gaussian, Anisotropic Diffusion, N4 |

#### Milestone 4: Enhancement (v0.5.0) - Week 13-16

| 항목 | 설명 | 완료 기준 |
|------|------|-----------|
| M4.1 | DR/CR 뷰잉 | 2D 영상 로드 및 조작 |
| M4.2 | 고급 분할 | Level Set, Watershed |
| M4.3 | 다중 레이블 분할 | 여러 장기 동시 분할, 레이블 관리 |
| M4.4 | 분할 저장/로드 | NRRD, NIfTI 포맷 지원 |
| M4.5 | ROI 관리 | ROI 목록, 이름/색상, 저장/로드 |
| M4.6 | 볼륨 측정 | 분할 영역 볼륨, 표면적 계산 |
| M4.7 | 고급 정량 분석 | 구형도, 신장비, 무게중심 |
| M4.8 | 분석 리포트 | PDF/CSV 내보내기, DICOM SR |
| M4.9 | 영상 정합 | Rigid Registration |
| M4.10 | STL 내보내기 | 3D 프린팅용 메시 |
| M4.11 | 사용자 설정 | 레이아웃, 프리셋 저장 |

---

## 8. Risks & Mitigations

### 8.1 Technical Risks

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| GPU 호환성 문제 | High | Medium | vtkSmartVolumeMapper로 CPU 폴백 |
| 대용량 데이터 메모리 부족 | High | Medium | 스트리밍 로딩, LOD 구현 |
| ITK-VTK 버전 호환성 | Medium | Low | vcpkg로 버전 고정 |
| 압축 포맷 디코딩 실패 | Medium | Low | pacs_system 코덱 사전 검증 |

### 8.2 Schedule Risks

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| VTK/ITK 학습 곡선 | Medium | High | 참조 문서 기반 예제 코드 활용 |
| PACS 연동 복잡성 | Medium | Medium | 단위 테스트 환경 구축 |
| UI/UX 요구사항 변경 | Low | Medium | 도킹 패널로 유연한 구조 |

---

## 9. Appendix

### A. Supported DICOM Modalities

| Modality | Code | Priority | 3D Support | 특징 |
|----------|------|----------|------------|------|
| CT | CT | P0 | Yes | 볼륨 렌더링, MPR, HU |
| MRI | MR | P0 | Yes | 볼륨 렌더링, MPR, 다중 시퀀스 |
| DR (Digital Radiography) | DX | P2 | No | 2D 뷰잉 |
| CR (Computed Radiography) | CR | P2 | No | 2D 뷰잉 |
| PET | PT | P3 | Yes | 융합 뷰 (향후) |
| US (Ultrasound) | US | P3 | Limited | 2D 뷰잉 (향후) |

### B. DICOM Tag Reference

주요 DICOM 태그는 [04-dicom-pipeline.md](reference/04-dicom-pipeline.md#22-핵심-dicom-태그) 참조.

### C. Coordinate Systems

좌표계 정보는 [03-itk-vtk-integration.md](reference/03-itk-vtk-integration.md#3-좌표계-통합) 참조.

### D. Related Documentation

| Document | Location | Purpose |
|----------|----------|---------|
| ITK Overview | [01-itk-overview.md](reference/01-itk-overview.md) | ITK 아키텍처 및 API |
| VTK Overview | [02-vtk-overview.md](reference/02-vtk-overview.md) | VTK 아키텍처 및 API |
| ITK-VTK Integration | [03-itk-vtk-integration.md](reference/03-itk-vtk-integration.md) | 통합 가이드 |
| DICOM Pipeline | [04-dicom-pipeline.md](reference/04-dicom-pipeline.md) | 처리 파이프라인 |
| pacs_system Integration | [05-pacs-integration.md](reference/05-pacs-integration.md) | PACS 연동 |

---

## Version History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 0.1.0 | 2025-12-31 | Development Team | Initial PRD |
| 0.2.0 | 2025-12-31 | Development Team | 세그먼테이션 및 영역 측정 기능 상세화 (FR-006, FR-007 확장, FR-012, FR-013 추가) |

> **Note**: v0.x.x는 Pre-release 버전입니다. 정식 릴리스는 v1.0.0부터 시작됩니다.

---

*This document is subject to change based on stakeholder feedback and technical discoveries during development.*
